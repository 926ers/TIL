3줄 요약
관련 모든 서비스들의 DB 트랜잭션을 순차적으로 처리하는 패턴

하나의 트랜잭션이 롤백되면 이전 트랜잭션도 롤백하기 위해 보상 이벤트를 실행

따라서 soft_delete 처리를 해야 보상 트랜잭션 처리하기 쉽다!

## **SAGA 패턴의 정의**

SAGA 패턴이란 **마이크로서비스들끼리 이벤트를 주고 받아 특정 마이크로서비스에서의 작업이 실패하면 이전까지의 작업이 완료된 마이크서비스들에게 보상 (complemetary) 이벤트를 소싱함으로써 분산 환경에서 원자성(atomicity)을 보장**하는 패턴

핵심은 **트랜잭션의 관리주체가 DBMS에 있는 것이 아닌 Application**에 있습니다. Application이 분산되어 있을때는 각 Applicatin은 하위에 존재하는 DB는 local 트랜잭션만 담당합니다.

즉, 각각의 Application의 트랜잭션 요청의 실패로 인한 Rollback 처리(보상 트랜잭션)은 Application에서 구현합니다.

이러한 과정을 통해서 순차적으로 트랜잭션이 처리되며, 마지막 트랜잭션이 끝났을 때 데이터가 완전히 영속되었음을 확인하고 종료합니다. 이 방법을 통해서 최종 일관성(Eventually Consistency)를 달성할 수 있습니다.

![Untitled.png](https://github.com/926ers/TIL/blob/main/2024_05_20/kbs/asset/Untitled.png?raw=true)



Choreography-based Saga 패턴은 보유한 서비스 내의 Local 트랜잭션을 관리하며 트랜잭션이 종료하게 되면 완료 Event를 발행합니다. 만약 그 다음 수행해야할 트랜잭션이 있으면 해당 트랜잭션을 수행해야하는 App으로 이벤트를 보내고, 해당 App은 완료 Event를 수신받고 다음 작업을 진행합니다. 이를 순차적으로 수행합니다. 이때 Event는 Kafka와 같은 메시지 큐를 통해서 비동기 방식으로 전달할 수 있습니다.

Choreography-base Saga 패턴에서는 각 App별로 트랜잭션을 관리하는 로직이 있습니다. 이를 통해서 중간에 트랜잭션이 실패하면 해당 트랜잭션 취소 처리를 실패한 App에서 보상 Event를 발행해서 Rollback 처리를 시도합니다.

## 프로젝트 적용

그룹유저나 그룹도 soft_delete처리를 하여 보상 트랜잭션할수 있도록 한다

**성공한 경우**
유저 소프트 삭제

그룹 서비스로 이벤트 전파

해당 유저가 있는 그룹에 서비스 로직 처리

메세지 서비스로 처리한 그룹 id 리스트 전파 + 그룹장 여부도 저장해서

메세지 서비스에서 메세지 저장 및 웹소켓 서비스로 해당 정보 전달

유저 서비스로 완료 이벤트 전파



**메세지 서비스에서 실패한 경우**

유저 소프트 삭제

그룹 서비스로 이벤트 전파

해당 유저가 있는 그룹에 서비스 로직 처리

메세지 서비스로 처리한 그룹 id 리스트 전파
메세지 서비스에서 메세지 저장중 실패
메세지 서비스 롤백
그룹 서비스로 그룹 id 리스트와 보상 트랜잭션 처리 이벤트 전파
해당 그룹에서 삭제처리된 그룹 유저 되돌리기 + 그룹장도 되돌리기
유저 서비스에서 삭제 취소 처리

## 고려사항

어떤 이벤트를 전파했는지 로그를 알수 있어야합니다.

첫 로그에 UUID를 넣는거 어떻까여
